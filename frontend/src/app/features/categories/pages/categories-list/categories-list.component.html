<div class="body-container">
  @let sort = (sort$|async);
  <header>
    <h1>Catégorie</h1>
    <app-sort-buttons
      [ngModel]="sort"
      (ngModelChange)="categoriesStore.setSort($event)"
      [options]="sortOptions">
    </app-sort-buttons>
  </header>

  <div class="table-container" [style.border-bottom-width]="sort === 'alphabet' ? '0': '1px'">

    <!--  Filters & Search  -->
    <div class="large-row filter-container" [style.border-bottom-width]="sort === 'alphabet' ? '1px' :'0'">
      <app-search-bar [ngModel]="search$|async" (ngModelChange)="categoriesStore.setSearch($event)"/>
      <app-select
        [options]="groups$|async"
        [ngModel]="selectedGroupId$|async"
        [labelKey]="'name'"
        [valueKey]="'id'"
        [defaultOption]="{value: null, label: 'Tous les groupes de catégories'}"
        (ngModelChange)="categoriesStore.setGroup($event)">
      </app-select>
    </div>

    <!--  Categories table  -->
    <div class="table">
      @if ((filteredCategories$|async).length > 0) {
        @if (sort === 'alphabet') {
          <!-- Alphabetical Order, without group -->
          @for (row of (filteredCategories$|async | sliceToRows:listColumnNumber); track row) {
            <ng-container *ngTemplateOutlet="tableItem; context: {row, showTag: true}"></ng-container>
          }

        } @else {

          <!-- Group Order -->
          @for (categoriesByGroup of (categoriesByGroup$|async); track categoriesByGroup.group.id) {
            <div class="list-group">
              <div class="group-title"
                   [ngClass]="categoriesByGroup.group.color ? categoriesByGroup.group.color : 'm-no-color'">
                {{ categoriesByGroup.group.name }}
              </div>
              <div class="table-row">
                @for (row of (categoriesByGroup.categories | sliceToRows:listColumnNumber); track row) {
                    <ng-container *ngTemplateOutlet="tableItem; context: {row, showTag: false}"></ng-container>
                }
              </div>
            </div>
          }
        }
      } @else {
        <div class="large-row no-data">
          <p>Aucune catégorie ne correspond à la recherche.</p>
          <button class="primary-button-outline" (click)="categoriesStore.clearFilters()">Effacer les filtres</button>
        </div>
      }
    </div>
  </div>

  <footer>
    <button class="primary-button"
            [class.disabled]="!selectedCategory"
            (click)="displayCategory()"
            tabindex="0"
            [disabled]="!selectedCategory">
      Sélectionner la catégorie
    </button>
  </footer>
</div>

<!-- COLUMN ITEM TEMPLATE -->
<ng-template #tableItem let-row="row" let-showTag="showTag">
  <div class="table-cell" [style.grid-template-columns]="'repeat(' + listColumnNumber + ', 1fr)'">

    @for (category of row; track category.id) {
      <app-category-card
        class="cell"
        [category]="category"
        [isCategorySelected]="selectedCategory?.id === category.id"
        [showTag]="showTag"
        (selection)="getSelectedCategory($event)">
      </app-category-card>
    }

    @for (empty of getEmptyColumns(row.length, listColumnNumber); track $index) {
      <div class="cell empty-cell"></div>
    }

  </div>
</ng-template>
